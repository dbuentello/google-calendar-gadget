<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs
     title="Ebility gadget"
     height="700"
     width="170"
     description="Time tracker"
     author="NicolÃ¡s Peralta"
     author_email="nperalta@gmail.com">
    <Require feature="google.calendar-0.5"/>
    <Require feature="dynamic-height"/>
  </ModulePrefs>
  <Content type="html">
    <![CDATA[

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

<!-- jquery -->
<script src="//code.jquery.com/jquery-latest.min.js"></script>

<!-- Latest compiled and minified JavaScript -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

<!-- bootstrap datepicker -->
<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/js/bootstrap-datepicker.js"></script>

<!-- bootstrap datepicker CSS -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker.css">

<!-- bootstrap timepicker CSS -->
<link rel="stylesheet" href="//cdn.jsdelivr.net/bootstrap.timepicker/0.2.3/css/bootstrap-timepicker.min.css">

<!-- bootstrap timepicker -->
<script src="//cdn.jsdelivr.net/bootstrap.timepicker/0.2.3/js/bootstrap-timepicker.min.js"></script>





<style>
#gadgetcell {
  width: 175px !important;
}
.container {
  padding: 0 !important;  
}
.col-md-1 {
  padding: 0 !important;  
}
.well {
  padding: 6px !important;
  margin-top: -4px !important;
}
.table-condensed {
  font-size: 10px !important;
}
.datepicker {
  left: 0 !important;
}

input.datepicker,input.input-small {
  width: 140px;
}


</style>
<script>

function stringToXML(str) {
  //code for IE
  if (window.ActiveXObject) { 
   var o_xml = new ActiveXObject("Microsoft.XMLDOM"); o_xml.loadXML(str);
    return o_xml;
  }
  // code for Chrome, Safari, Firefox, Opera, etc. 
  else {
    return (new DOMParser()).parseFromString(str, "text/xml");
  }
}
// Changes XML to JSON
function xmlToJson(xml) {
  
  // Create the return object
  var obj = {};

  if (xml.nodeType == 1) { // element
    // do attributes
    if (xml.attributes.length > 0) {
    obj["@attributes"] = {};
      for (var j = 0; j < xml.attributes.length; j++) {
        var attribute = xml.attributes.item(j);
        obj["@attributes"][attribute.nodeName] = attribute.nodeValue;
      }
    }
  } else if (xml.nodeType == 3) { // text
    obj = xml.nodeValue;
  }

  // do children
  if (xml.hasChildNodes()) {
    for(var i = 0; i < xml.childNodes.length; i++) {
      var item = xml.childNodes.item(i);
      var nodeName = item.nodeName;
      if (typeof(obj[nodeName]) == "undefined") {
        obj[nodeName] = xmlToJson(item);
      } else {
        if (typeof(obj[nodeName].push) == "undefined") {
          var old = obj[nodeName];
          obj[nodeName] = [];
          obj[nodeName].push(old);
        }
        obj[nodeName].push(xmlToJson(item));
      }
    }
  }
  return obj;
};

function login(username, password, callback) { 
  var data = { UserName: username, Password: password };
  makePOSTRequest("http://qa.ebillity.com/restservice/api/mobile/validateuser", data, callback); 
}

function get_projects(session_id, user_id, callback) {
  var data = { "UserId" : user_id, "SessionId" : session_id, "LastSyncedOn" : "2014-01-01 17:15:45", "ResetSync" : false };
  var post_url = "http://qa.ebillity.com/restservice/api/mobile/SyncData";
  makePOSTRequest(post_url, data, callback);   
}

function makePOSTRequest(url, postdata, callback) {
  var params = {};
  postdata = gadgets.io.encodeValues(postdata);
  params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.POST;
  params[gadgets.io.RequestParameters.POST_DATA]= postdata;
  gadgets.io.makeRequest(url, callback, params); 

};

var mobile_sync_data;

function render_projects(obj) {
  var mobile_sync_data = xmlToJson(stringToXML(obj.data));
  var html = '' ;
  var firms = mobile_sync_data.MobileSyncData.Firms.Firm;
  html += '<label>Firm</label>';
  html += '<select id=firms class=form-control>';
  
  for (var i = 0; i < firms.length; i++) {
    firm_id   = firms[i].FirmId["#text"];
    firm_name = firms[i].FirmName["#text"];
    html += '<option value=' + firm_id + '>' + firm_name + '</option>';
  };

  html += '</select><br>';

  html += '<label>Project</label>';
  html += '<select id=projects class=form-control>';
  html += '</select><br>';  

  html += '<label>Activity</label>';
  html += '<select id=activities class=form-control>';
  html += '</select><br>';  

  $('#project-info').html(html);
  console.log(mobile_sync_data);
    
  // bind change 
  $('#firms').change(function(){

    var firms = mobile_sync_data.MobileSyncData.Firms.Firm;
    console.log(firms);
    var html = '';
    for (var i = 0; i < firms.length; i++) {
      firm_id   = firms[i].FirmId["#text"];
      firm_name = firms[i].FirmName["#text"];
      // look for the firm id
      if ($(this).val() == firm_id) {
        // get the project
        projects = firms[i].ClientProjects;

        // check if it's not empty (projects)
        if (projects.MobileClientProject) {
          mobile_project = projects.MobileClientProject;
          // make the project's options
          for (var j = 0 ; j < mobile_project.length; j++) {
            client_id = mobile_project[j].ClientId["#text"];
            client_name = mobile_project[j].ClientProjectName["#text"];
            html += '<option value=' + client_id + '>' + client_name + '</option>';
          };

        }

        // render
        $('#projects').html(html);

        // log projects
        console.log(projects);

        // empty html
        html = '';
        // get activity
        activities = firms[i].ActivityType;

        // check if it's not empty (activities)
        if (activities.MobileActivityType) {
          mobile_activity = activities.MobileActivityType;
          // make the project's options
          for (var k = 0 ; k < mobile_activity.length; k++) {
            activity_id = mobile_activity[k].ActivityTypeId["#text"];
            activity_name = mobile_activity[k].ActivityTypeName["#text"];
            html += '<option value=' + activity_id + '>' + activity_name + '</option>';
          };

        }

        // render
        $('#activities').html(html);

        // log projects
        console.log(activities);


      }

    };
        //html += '<option value=' + firm_id + '>' + firm_name + '</option>';

  });

}

function today () {

  var d = new Date();

  var month = d.getMonth()+1;
  var day = d.getDate();

  var output = d.getFullYear() + '/' +
    (month<10 ? '0' : '') + month + '/' +
    (day<10 ? '0' : '') + day;

  return output;
}


</script>
</head>

<body>

<div class="container">

    <div class="well" id="project-info">
    Loading...

    </div>
    <div class="well">
      <label>Date</label>
      <input class="datepicker" data-date-format="mm/dd/yyyy" id="date">
      <label>Start time</label>
      <div class="input-append bootstrap-timepicker">
        <input id="timepicker1" type="text" class="input-small">
        <span class="add-on"><i class="icon-time"></i></span>
      </div>
      <label>End time</label>
      <div class="input-append bootstrap-timepicker">
        <input id="timepicker2" type="text" class="input-small">
        <span class="add-on"><i class="icon-time"></i></span>
      </div>
      <a href="#" class="btn btn-primary btn-default">Next <span class="glyphicon glyphicon-chevron-right"></span></a>
    </div>

</div>
<script>

// Force the screen to resize
// gadgets.window.adjustHeight();

// login user and render selects
login("ajsri77@gmail.com", "Sriram0304", function(obj) {          
  var json_data  = xmlToJson(stringToXML(obj.data));
  var session_id = json_data.MobileLoginResponse.SessionId["#text"];
  var user_id    = json_data.MobileLoginResponse.UserId["#text"];
  get_projects(session_id, user_id, render_projects);

});

$(function(){

  $('.datepicker').datepicker();
  $('#timepicker1').timepicker();
  $('#timepicker2').timepicker();

});

</script>    
]]></Content>
</Module>
<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs
     title="Ebility gadet"
     height="500"
     description="Time tracker"
     author="NicolÃ¡s Peralta"
     author_email="nperalta@gmail.com">
    <Require feature="google.calendar-0.5"/>
    <Require feature="dynamic-height"/>
  </ModulePrefs>
  <Content type="html">
    <![CDATA[

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">


<script src="//code.jquery.com/jquery-latest.min.js"></script>

<!-- Latest compiled and minified JavaScript -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

<style>
#gadgetcell {
  width: 175px !important;
}
.container {
  padding: 0 !important;  
}
.col-md-1 {
  padding: 0 !important;  
}
.well {
  padding: 9px !important;
}
</style>
<script>

function stringToXML(str) {
  //code for IE
  if (window.ActiveXObject) { 
   var o_xml = new ActiveXObject("Microsoft.XMLDOM"); o_xml.loadXML(str);
    return o_xml;
  }
  // code for Chrome, Safari, Firefox, Opera, etc. 
  else {
    return (new DOMParser()).parseFromString(str, "text/xml");
  }
}
// Changes XML to JSON
function xmlToJson(xml) {
  
  // Create the return object
  var obj = {};

  if (xml.nodeType == 1) { // element
    // do attributes
    if (xml.attributes.length > 0) {
    obj["@attributes"] = {};
      for (var j = 0; j < xml.attributes.length; j++) {
        var attribute = xml.attributes.item(j);
        obj["@attributes"][attribute.nodeName] = attribute.nodeValue;
      }
    }
  } else if (xml.nodeType == 3) { // text
    obj = xml.nodeValue;
  }

  // do children
  if (xml.hasChildNodes()) {
    for(var i = 0; i < xml.childNodes.length; i++) {
      var item = xml.childNodes.item(i);
      var nodeName = item.nodeName;
      if (typeof(obj[nodeName]) == "undefined") {
        obj[nodeName] = xmlToJson(item);
      } else {
        if (typeof(obj[nodeName].push) == "undefined") {
          var old = obj[nodeName];
          obj[nodeName] = [];
          obj[nodeName].push(old);
        }
        obj[nodeName].push(xmlToJson(item));
      }
    }
  }
  return obj;
};

function login(username, password, callback) { 
  var data = { UserName: username, Password: password };
  makePOSTRequest("http://qa.ebillity.com/restservice/api/mobile/validateuser", data, callback); 
}

function get_projects(session_id, user_id, callback) {
  var data = { "UserId" : user_id, "SessionId" : session_id, "LastSyncedOn" : "2014-01-01 17:15:45", "ResetSync" : false };
  var post_url = "http://qa.ebillity.com/restservice/api/mobile/SyncData";
  makePOSTRequest(post_url, data, callback);   
}

function makePOSTRequest(url, postdata, callback) {
  var params = {};
  postdata = gadgets.io.encodeValues(postdata);
  params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.POST;
  params[gadgets.io.RequestParameters.POST_DATA]= postdata;
  gadgets.io.makeRequest(url, callback, params); 

};

var mobile_sync_data;

function render_projects(obj) {
  var mobile_sync_data = xmlToJson(stringToXML(obj.data));
  var html = '' ;
  var firms = mobile_sync_data.MobileSyncData.Firms.Firm;
  html += '<label>Firm</label>';
  html += '<select id=firms class=form-control>';
  
  for (var i = 0; i < firms.length; i++) {
    firm_id   = firms[i].FirmId["#text"];
    firm_name = firms[i].FirmName["#text"];
    html += '<option value=' + firm_id + '>' + firm_name + '</option>';
  };

  html += '</select><br>';

  html += '<label>Project</label>';
  html += '<select id=projects class=form-control>';
  html += '</select><br>';  

  html += '<label>Activity</label>';
  html += '<select id=activities class=form-control>';
  html += '</select><br>';  

  $('#project-info').html(html);
  console.log(mobile_sync_data);
    
  // bind change 
  $('#firms').change(function(){

    var firms = mobile_sync_data.MobileSyncData.Firms.Firm;
    console.log(firms);
    var html = '';
    for (var i = 0; i < firms.length; i++) {
      firm_id   = firms[i].FirmId["#text"];
      firm_name = firms[i].FirmName["#text"];
      // look for the firm id
      if ($(this).val() == firm_id) {
        // the data is in clientProjects
        projects = firms[i].ClientProjects;

        // check if it's not empty
        if (projects.MobileClientProject) {
          mobile_project = projects.MobileClientProject;
          for (var j = 0 ; j < mobile_project.length; j++) {
            client_id = mobile_project[j].ClientId["#text"];
            client_name = mobile_project[j].ClientProjectName["#text"];
            html += '<option value=' + client_id + '>' + client_name + '</option>';
          };

        }
        $('#projects').html(html);
        console.log(projects);
      }

    };
        //html += '<option value=' + firm_id + '>' + firm_name + '</option>';

  });

}
</script>
</head>

<body>

<div class="container">

    <div class="well" id="project-info">
    Loading...

    </div>
    <div class="well">

    </div>

</div>
<script>

// Force the screen to resize
// gadgets.window.adjustHeight();

// login user and render selects
login("ajsri77@gmail.com", "Sriram0304", function(obj) {          
  var json_data  = xmlToJson(stringToXML(obj.data));
  var session_id = json_data.MobileLoginResponse.SessionId["#text"];
  var user_id    = json_data.MobileLoginResponse.UserId["#text"];
  get_projects(session_id, user_id, render_projects);

});

</script>    
]]></Content>
</Module>